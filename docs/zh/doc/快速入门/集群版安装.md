# 安装集群版

## 集群版功能说明

| 类型     | 组件                               | 最小生产集群 | 第三方依赖                           | 功能说明           |
| -------- | ---------------------------------- | ------------ | ------------------------------------ | ------------------ |
| 核心(必选)     | polaris-console,  polaris-discover | 2*VM/POD     | MySQL 5.7                            | 服务注册，服务发现 |
| 健康检查(可选) | polaris-healthcheck                | 2*VM/POD     | Redis 5.0                            | 心跳上报           |
| 可观察性(可选) | -                                  | 2*VM/POD     | Prometheus 2.28.0, PushGateway 1.4.1 | 客户端监控上报     |


## 核心功能安装

### 集群组网

![核心组网](图片\集群版安装\核心组网.png)

为保证容灾性，需要2节点（VM/POD），建议每台机器上**同时部署polaris-discover与polaris-console**。

### 初始数据导入

在polaris的[releases](https://github.com/polarismesh/polaris/releases)上下载对应版本的源码包：Source code (zip) 

解压源码包并执行导入：

```bash
unzip polaris-$version.zip
cd polaris-$version
mysql -u $db_user -p $db_pwd -h $db_host < store/defaultStore/polaris_server.sql
```


### 虚拟机linux

#### 安装polaris-discover

- 下载软件包：在polaris的[releases](https://github.com/polarismesh/polaris/releases)上下载对应的软件包：polaris-server-release_$version.linux.$arch.zip，解压后进入polaris-server-release_$version.linux.$arch目录

- 配置数据库参数：修改polaris-server.yaml里面的存储配置（根节点为store），修改后的配置如下所示（##DB_USER##，##DB_PWD##，##DB_ADDR##，##DB_NAME##需替换成实际的数据库访问地址以及凭证）：
```
# 存储配置
store:
## 单机文件存储插件
#  name: boltdbStore
#  option:
#    path: ./polaris.bolt
# 数据库存储插件
  name: defaultStore
  option:
    master:
      dbType: mysql
      dbUser: ##DB_USER##
      dbPwd: ##DB_PWD##
      dbAddr: ##DB_ADDR##
      dbName: ##DB_NAME##
      maxOpenConns: -1
      maxIdleConns: -1
      connMaxLifetime: 300 # 单位秒
      txIsolationLevel: 2 #LevelReadCommitted
```

- 开启自动注册：修改polaris-server.yaml里面的服务自注册配置（根节点为bootstrapt），打开enable_register以及probe_address的选项，并将##DB_ADDR##替换成实际的数据库地址）
```
bootstrap:
  polaris_service:
    probe_address: ##DB_ADDR##
    enable_register: true
    isolated: false
    services:
      - name: polaris.discover
        namespace: Polaris
        protocols:
          - grpcserver
          - httpserver    
```

- 启动polaris-discover：执行tool/start.sh，执行tool/p.sh，看到以下信息代表启动成功：
```
./polaris-server start
```

#### 安装polaris-console

- 下载软件包：在polaris-console的[releases](https://github.com/polarismesh/polaris-console/releases)上下载对应的软件包：polaris-console-release_$version.linux.$arch.zip，解压后进入polaris-console-release_$version.linux.$arch目录

- 启动polaris-console：执行tool/start.sh，执行tool/p.sh，看到以下信息代表启动成功：
```
./polaris-console start
```


### 容器化



## 健康检查功能安装

### 集群组网
![核心组网](图片\集群版安装\健康检查组网.png)

为保证容灾性，需要2节点（VM/POD）进行部署。

### 准备Redis

注册redis实例：登录polaris-discover所部署的机器，执行以下命令（将${redis_host}和${redis_port}替换成实际的地址信息
```
curl -XPOST -H 'Content-Type: application/json;charset=UTF-8' -d '[{"service":"polaris.redis","namespace":"Polaris","weight":100,"healthy":true,"isolate":false,"port":${redis_port},"host":"'${redis_host}'","enable_health_check":false,"metadata":{}}]' http://127.0.0.1:8090/naming/v1/instances
```

### 虚拟机linux

#### 安装polaris-healthcheck

- 下载软件包：在polaris的[releases](https://github.com/polarismesh/polaris/releases)上下载对应的软件包：polaris-server-release_$version.linux.$arch.zip，解压后进入polaris-server-release_$version.linux.$arch目录

- 配置数据库参数：修改polaris-server.yaml里面的存储配置（根节点为store），修改后的配置如下所示（##DB_USER##，##DB_PWD##，##DB_ADDR##，##DB_NAME##需替换成实际的数据库访问地址以及凭证）：
```
# 存储配置
store:
## 单机文件存储插件
#  name: boltdbStore
#  option:
#    path: ./polaris.bolt
# 数据库存储插件
  name: defaultStore
  option:
    master:
      dbType: mysql
      dbUser: ##DB_USER##
      dbPwd: ##DB_PWD##
      dbAddr: ##DB_ADDR##
      dbName: ##DB_NAME##
      maxOpenConns: -1
      maxIdleConns: -1
      connMaxLifetime: 300 # 单位秒
      txIsolationLevel: 2 #LevelReadCommitted
```

- 开启自动注册：修改polaris-server.yaml里面的服务自注册配置（根节点为bootstrapt），打开enable_register以及probe_address的选项，并将##DB_ADDR##替换成实际的数据库地址）
```
bootstrap:
  polaris_service:
    probe_address: ##DB_ADDR##
    enable_register: true
    isolated: false
    services:
      - name: polaris.healthcheck
        namespace: Polaris
        protocols:
          - grpcserver
          - httpserver    
```

- 配置redis密码：修改polaris-server.yaml里面的健康检查配置（根节点为naming），需要把##REDIS_PWD##替换成实际的redis密码
```
naming:
  # 健康检查
  healthcheck:
    open: true
    kvConnNum: 50
    kvServiceName: polaris.redis
    kvNamespace: Polaris
    kvPasswd: ##REDIS_PWD##
    slotNum: 30
    maxIdle: 20
    idleTimeout: 120
```

- 启动polaris-discover：执行tool/start.sh，执行tool/p.sh，看到以下信息代表启动成功：
```
./polaris-server start
```


### 容器化


## 可观察性功能安装

### 集群组网

![核心组网](图片\集群版安装\监控上报组网.png)


### 虚拟机linux

#### 安装promethues

- 下载软件包：点击[链接](https://github.com/prometheus/prometheus/releases/download/v2.28.0/prometheus-2.28.0.linux-amd64.tar.gz)，下载prometheus版本，解压后进入prometheus-2.28.0.linux-amd64目录中。

- 修改配置：打开 prometheus.yml文件，在最下面添加pushgateway的相关配置

```
  - job_name: 'push-metrics'
    static_configs:"
    - targets: ['localhost:9091']"
    honor_labels: true     
```

- 启动prometheus：
```
nohup ./prometheus --web.enable-lifecycle --web.enable-admin-api >> prometheus.out 2>&1 &
```

#### 安装pushgateway

- 下载软件包：点击[链接](https://github.com/prometheus/pushgateway/releases/download/v1.4.1/pushgateway-1.4.1.linux-amd64.zip)，下载pushgateway版本，解压后进入pushgateway-1.4.1.linux-amd64目录中。

- 启动pushgateway：

```
nohup ./pushgateway --web.enable-lifecycle --web.enable-admin-api >> pgw.out 2>&1 &
```

- 注册服务：

登录polaris-discover所部署的机器，执行以下命令（将${pushgateway_host}替换成实际的pushgateway的节点地址信息
```
curl -XPOST -H 'Content-Type: application/json;charset=UTF-8' -d '[{"service":"polaris.monitor","namespace":"Polaris","weight":100,"healthy":true,"isolate":false,"port":9091,"host":"'${pushgateway_host}'","enable_health_check":false,"metadata":{}}]' http://127.0.0.1:8090/naming/v1/instances
```

### 容器化部署

